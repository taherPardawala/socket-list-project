<html ng-app="list">
<head>
    <title>Chat app using express and socket</title>
    <style>
        #chatbox{
            height : 500px;
            overflow: scroll;
        }
        
        #chatbox ul{
            list-style: none;
            margin: 0;
            padding-left: 0px;
        }
        
        .redborder{
            border: 1px red solid;
            padding: 5px;
        }
        
        .deleteMe{
            float: right;
            background: yellow;
        }
        
        #chatWrap{
            float:left;
            border: 1px solid;
        }
        
        #users {
            border: 1px solid red;
            display: block;
            float: left;
            width: 200px;
        }
    </style>
    
</head>
<body>
    
    <div id="userWrap" ng-controller="userController" ng-show ="visible">
        <p>Enter a username</p>
        <p id="userError" ng-model="errormsg">{{errormsg}}</p>
        <form id="setUsername">
            <input size="35" id="namebox" ng-model = "username"/>
            <input type="submit" ng-click="setName($event)"/>
        </form>
    </div>
    
    <div id="chatContainer" ng-controller="chatController" ng-show="visible">
        <div id="chatWrap">
            <div id = "chatbox">
                <ul>
                    <li ng-repeat="msg in msglist">{{msg}}</li>
                </ul>
            </div>
            <form id = "sent-message">
                <input size = "35" id = "message" ng-model="newmsg"/>
                <input type = "submit" ng-click="sendMsg($event)"/>
            </form>
        </div>
        <div id="users">
            <ul>
                <li class="redborder" ng-repeat="user in usernames">{{user.name}} : {{user.msg}}</li>
            </ul>
        </div>
    </div>
    
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.6/angular.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.js" integrity="sha256-16cdPddA6VdVInumRGo6IbivbERE8p7CQR3HzTBuELA=" crossorigin="anonymous"></script>
    <script src = "/socket.io/socket.io.js"></script>
    
    <script>
        var socket = io.connect();
        var app = angular.module('list',[]);
        
        var userController = function($scope){
            socket.emit('update chat vis' , false);
            $scope.visible = true;
            
            $scope.setName = (e)=>{
                e.preventDefault();
                socket.emit('new user', $scope.username ,function(data){
                                
                                if(data){
                                    console.log(data);
                                    $scope.visible = false;
                                    socket.emit('update chat vis' , true);
                                }
                                else {
                                    $scope.errormsg = "Username is already taken";
                                }
                            });
                    $scope.username = "";
            };
            socket.on('username' , function(data){
                var usernames = data;
                $scope.usernames = usernames;
                //console.log($scope.usernames);
            });
        };
        
        var chatController = function($scope){
            
            $scope.msglist = [];
            socket.on('chatbox vis',function(data){
                $scope.visible = data;
                console.log("chat box: "+data)
            });
            
            $scope.sendMsg = (e)=>{
                e.preventDefault();
                socket.emit('send message' , $scope.newmsg);
                //$scope.msglist.push($scope.msg)
                $scope.newmsg = "";
            };
            
            socket.on('new message' , function(data){
                console.log(data);
                $scope.msglist = data;
                //chatlist.append('<li class="redborder" id="'+ data.id +'"> <b>'+ data.name +': </b>' +data.msg + '<button class="deleteMe">Remove</button> </li>');
            });
        };
        
        
        app.controller("userController" , userController);
        app.controller("chatController" , chatController);
        
    </script>
</body>
</html>